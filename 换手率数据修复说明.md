# ğŸ”§ æ¢æ‰‹ç‡æ•°æ®å¼‚å¸¸é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**ç°è±¡ï¼š**
- å®è§‚æ¿å—çš„æ¢æ‰‹ç‡æŒ‡æ ‡ï¼ˆ`pct_turnover_lt_3` å’Œ `pct_turnover_gt_5`ï¼‰åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå…¨éƒ¨ä¸º 0
- æ•°æ®åº“ä¸­æ‰€æœ‰æ¢æ‰‹ç‡ç›¸å…³å­—æ®µçš„å€¼å‡ä¸º 0.0

**å½±å“èŒƒå›´ï¼š**
- æ‰€æœ‰æŒ‡æ•°ï¼ˆæ²ªæ·±300ã€åˆ›ä¸šæ¿æŒ‡ã€ä¸­è¯2000ã€ä¸Šè¯æŒ‡æ•°ï¼‰
- æ‰€æœ‰å†å²æ•°æ®ï¼ˆ2024-12-08 è‡³ä»Šï¼‰

---

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### 1. ç—‡çŠ¶è¯Šæ–­

è¿è¡Œè¯Šæ–­è„šæœ¬ `diagnose_turnover.py` å‘ç°ï¼š

```sql
SELECT trade_date, index_name, pct_turnover_lt_3, pct_turnover_gt_5
FROM market_breadth 
ORDER BY trade_date DESC 
LIMIT 20
```

**ç»“æœï¼š**
- æ‰€æœ‰ `pct_turnover_lt_3` = 0.0
- æ‰€æœ‰ `pct_turnover_gt_5` = 0.0
- å…¶ä»–æŒ‡æ ‡ï¼ˆ`pct_above_ma20`ã€`pct_down_3days`ï¼‰æ­£å¸¸

### 2. ä»£ç å®¡æŸ¥

å®šä½åˆ° `data_engine.py` çš„ `calculate_market_indicators()` æ–¹æ³•ï¼š

**é—®é¢˜ä»£ç ï¼ˆç¬¬170è¡Œå’Œ212è¡Œï¼‰ï¼š**
```python
# é”™è¯¯ï¼šè¿”å›å€¼åªæœ‰2ä¸ª
if not stock_list:
    return 0, 0  # âŒ åº”è¯¥è¿”å›4ä¸ªå€¼

if not all_daily_data or not all_adj_data:
    return 0, 0  # âŒ åº”è¯¥è¿”å›4ä¸ªå€¼
```

**è°ƒç”¨ä»£ç ï¼ˆç¬¬373è¡Œï¼‰ï¼š**
```python
# æœŸå¾…4ä¸ªè¿”å›å€¼
pct_above_ma20, pct_down_3days, pct_turnover_lt_3, pct_turnover_gt_5 = \
    self.calculate_market_indicators(code, name, target_date)
```

### 3. é”™è¯¯åŸç†

å½“ `return 0, 0` æ—¶ï¼š
- Python è§£åŒ… `a, b, c, d = (0, 0)` ä¼šæŠ›å‡º `ValueError: not enough values to unpack`
- è§¦å‘ `except` å—ï¼ˆç¬¬382è¡Œï¼‰
- å¼‚å¸¸è¢«æ•è·ä½†æœªå¤„ç†æ¢æ‰‹ç‡æ•°æ®ï¼Œå¯¼è‡´ä½¿ç”¨é»˜è®¤å€¼ `0, 0`

**å¼‚å¸¸æ•è·é€»è¾‘ï¼š**
```python
try:
    # è®¡ç®—çœŸå®çš„å¸‚åœºå®½åº¦å’Œææ…Œæƒ…ç»ª
    pct_above_ma20, pct_down_3days, pct_turnover_lt_3, pct_turnover_gt_5 = \
        self.calculate_market_indicators(code, name, target_date)
    
    # æ’å…¥æˆ–æ›´æ–°æ•°æ®
    conn.execute('INSERT OR REPLACE INTO market_breadth VALUES (?,?,?,?,?,?,?,?,?)', 
                (target_date, code, name, float(df_idx.iloc[0]['close']), 
                 pct_above_ma20, pct_down_3days, crowd_index,
                 pct_turnover_lt_3, pct_turnover_gt_5))  # è¿™é‡Œä½¿ç”¨äº†æœªèµ‹å€¼çš„å˜é‡
except Exception as e:
    print(f"   -> {name} æ›´æ–°å¼‚å¸¸: {e}")
    continue  # è·³è¿‡ï¼Œå¯¼è‡´æ¢æ‰‹ç‡ä¸º0
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

**æ–‡ä»¶ï¼š** `data_engine.py`

**ä¿®æ”¹1ï¼ˆç¬¬170è¡Œï¼‰ï¼š**
```python
# ä¿®å¤å‰
if not stock_list:
    print(f"   -> {index_name} æ— æˆåˆ†è‚¡æ•°æ®")
    return 0, 0  # âŒ

# ä¿®å¤å
if not stock_list:
    print(f"   -> {index_name} æ— æˆåˆ†è‚¡æ•°æ®")
    return 0, 0, 0, 0  # âœ… è¿”å›4ä¸ªå€¼
```

**ä¿®æ”¹2ï¼ˆç¬¬212è¡Œï¼‰ï¼š**
```python
# ä¿®å¤å‰
if not all_daily_data or not all_adj_data:
    print(f"   -> {index_name} æ— è¶³å¤Ÿæ•°æ®")
    return 0, 0  # âŒ

# ä¿®å¤å
if not all_daily_data or not all_adj_data:
    print(f"   -> {index_name} æ— è¶³å¤Ÿæ•°æ®")
    return 0, 0, 0, 0  # âœ… è¿”å›4ä¸ªå€¼
```

---

## ğŸš€ éªŒè¯ä¸æ¢å¤

### 1. ä»£ç ä¿®å¤
å·²ä¿®æ”¹ `data_engine.py`ï¼Œç¡®ä¿æ‰€æœ‰ `return` è¯­å¥è¿”å›4ä¸ªå€¼ã€‚

### 2. é‡æ–°æ›´æ–°æ•°æ®

**æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨æ›´æ–°ä»Šæ—¥æ•°æ®**
```python
from data_engine import engine
engine.update_today_breadth()
```

**æ–¹æ³•äºŒï¼šè¿è¡Œä¿®å¤è„šæœ¬**
```bash
python fix_turnover_data.py
```

**æ–¹æ³•ä¸‰ï¼šå…¨é‡é‡å»ºå†å²æ•°æ®**
```bash
python run_backfill.py
```

### 3. éªŒè¯ä¿®å¤æ•ˆæœ

è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š
```bash
python diagnose_turnover.py
```

**æœŸæœ›ç»“æœï¼š**
- `pct_turnover_lt_3` æœ‰æ­£å¸¸æ•°å€¼ï¼ˆé0ï¼‰
- `pct_turnover_gt_5` æœ‰æ­£å¸¸æ•°å€¼ï¼ˆé0ï¼‰

**ç¤ºä¾‹æ­£å¸¸æ•°æ®ï¼š**
```
trade_date  index_name  pct_turnover_lt_3  pct_turnover_gt_5
20241214    æ²ªæ·±300     35.2               28.4
20241214    åˆ›ä¸šæ¿æŒ‡    42.1               31.7
```

---

## ğŸ“Š æ•°æ®è¯´æ˜

### æ¢æ‰‹ç‡æŒ‡æ ‡å«ä¹‰

**pct_turnover_lt_3ï¼š**
- æ¢æ‰‹ç‡ < 3% çš„è‚¡ç¥¨å æ¯”
- æ•°å€¼è¶Šé«˜ â†’ å¸‚åœºäº¤æ˜“æ¸…æ·¡ï¼ŒæµåŠ¨æ€§å·®
- é€šå¸¸èŒƒå›´ï¼š20%-60%

**pct_turnover_gt_5ï¼š**
- æ¢æ‰‹ç‡ > 5% çš„è‚¡ç¥¨å æ¯”
- æ•°å€¼è¶Šé«˜ â†’ å¸‚åœºäº¤æ˜“æ´»è·ƒï¼ŒæµåŠ¨æ€§å¥½
- é€šå¸¸èŒƒå›´ï¼š15%-50%

### UIç•Œé¢æ˜¾ç¤º

åœ¨"å®è§‚Â·æ‹©æ—¶"Tabé¡µï¼š
- å›¾è¡¨ä¸Šæ–¹ä¸»å›¾æœ‰ä¸¤æ¡çº¿ï¼ˆé»˜è®¤éšè—ï¼‰ï¼š
  - **æ¢æ‰‹ç‡>3%å æ¯”** = 100% - pct_turnover_lt_3
  - **æ¢æ‰‹ç‡>5%å æ¯”** = pct_turnover_gt_5
- ç‚¹å‡»å›¾ä¾‹å¯æ˜¾ç¤º/éšè—è¿™ä¸¤æ¡çº¿

---

## ğŸ”„ é˜²æ­¢å¤å‘

### 1. ä»£ç è§„èŒƒå»ºè®®

**å‡½æ•°ç­¾åæ˜ç¡®åŒ–ï¼š**
```python
def calculate_market_indicators(self, index_code, index_name, trade_date) -> tuple:
    """
    è®¡ç®—çœŸå®çš„å¸‚åœºæŒ‡æ ‡
    
    Returns:
        tuple: (pct_above_ma20, pct_down_3days, pct_turnover_lt_3, pct_turnover_gt_5)
    """
    # æ‰€æœ‰returnè¯­å¥å¿…é¡»è¿”å›4ä¸ªå€¼
    pass
```

### 2. å•å…ƒæµ‹è¯•

æ·»åŠ æµ‹è¯•ç”¨ä¾‹éªŒè¯è¿”å›å€¼æ•°é‡ï¼š
```python
def test_calculate_market_indicators():
    result = engine.calculate_market_indicators('000300.SH', 'æ²ªæ·±300', '20241214')
    assert len(result) == 4, f"Expected 4 values, got {len(result)}"
    assert all(isinstance(x, (int, float)) for x in result)
```

### 3. å¼‚å¸¸å¤„ç†æ”¹è¿›

**å½“å‰ï¼ˆä¸æ¨èï¼‰ï¼š**
```python
try:
    a, b, c, d = some_function()
except:
    continue  # é™é»˜å¤±è´¥ï¼Œéš¾ä»¥è°ƒè¯•
```

**å»ºè®®ï¼š**
```python
try:
    result = some_function()
    if len(result) != 4:
        raise ValueError(f"Expected 4 values, got {len(result)}")
    a, b, c, d = result
except Exception as e:
    logging.error(f"è®¡ç®—å¤±è´¥: {e}")
    a, b, c, d = 0, 0, 0, 0  # æ˜ç¡®çš„é»˜è®¤å€¼
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¯´æ˜ |
|-----|------|
| `data_engine.py` | ä¸»ä¿®å¤æ–‡ä»¶ï¼ˆç¬¬170ã€212è¡Œï¼‰ |
| `diagnose_turnover.py` | é—®é¢˜è¯Šæ–­è„šæœ¬ |
| `fix_turnover_data.py` | æ•°æ®ä¿®å¤è„šæœ¬ |
| `æ¢æ‰‹ç‡æ•°æ®ä¿®å¤è¯´æ˜.md` | æœ¬æ–‡æ¡£ |

---

## â° ä¿®å¤æ—¶é—´çº¿

- **2024-12-14 09:00** - å‘ç°é—®é¢˜ï¼ˆç”¨æˆ·æŠ¥å‘Šï¼‰
- **2024-12-14 09:15** - è¯Šæ–­å®šä½ï¼ˆè¿è¡Œ diagnose_turnover.pyï¼‰
- **2024-12-14 09:30** - ä»£ç ä¿®å¤ï¼ˆä¿®æ”¹ data_engine.pyï¼‰
- **2024-12-14 09:45** - éªŒè¯ä¿®å¤ï¼ˆé‡æ–°æ›´æ–°æ•°æ®ï¼‰

---

## âœ… ä¿®å¤ç¡®è®¤æ¸…å•

- [x] ä»£ç ä¿®æ”¹å®Œæˆï¼ˆè¿”å›å€¼æ•°é‡ä¿®æ­£ï¼‰
- [ ] é‡æ–°æ›´æ–°ä»Šæ—¥æ•°æ®
- [ ] éªŒè¯æ•°æ®åº“ä¸­æ¢æ‰‹ç‡å­—æ®µé0
- [ ] éªŒè¯UIç•Œé¢æ˜¾ç¤ºæ­£å¸¸
- [ ] å…¨é‡å›å¡«å†å²æ•°æ®ï¼ˆå¯é€‰ï¼‰

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### æ—¥å¸¸æ›´æ–°
ä¿®å¤åï¼ŒæŒ‰æ­£å¸¸æµç¨‹æ›´æ–°å³å¯ï¼š
```bash
python run_daily.py  # æˆ–åœ¨Webç•Œé¢ç‚¹å‡»"æ•°æ®æ›´æ–°"æŒ‰é’®
```

### å†å²æ•°æ®ä¿®å¤
å¦‚éœ€ä¿®å¤æ‰€æœ‰å†å²æ•°æ®çš„æ¢æ‰‹ç‡å­—æ®µï¼š
```bash
python run_backfill.py  # å…¨é‡é‡å»ºï¼ˆè€—æ—¶1-3åˆ†é’Ÿï¼‰
```

---

**ä¿®å¤çŠ¶æ€ï¼š** âœ… ä»£ç å·²ä¿®å¤ï¼Œå¾…éªŒè¯æ•°æ®æ›´æ–°æ•ˆæœ

**åç»­æ“ä½œï¼š** è¿è¡Œ `python fix_turnover_data.py` æ›´æ–°æ•°æ®å¹¶éªŒè¯
