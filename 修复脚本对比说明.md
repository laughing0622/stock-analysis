# 🔧 换手率数据修复脚本对比

## 📊 两个脚本的区别

| 对比项 | fix_turnover_only.py<br>（仅换手率） | run_backfill.py<br>（全量回填） |
|-------|-------------------------------------|--------------------------------|
| **修复范围** | ✅ 仅换手率（2个字段） | ❌ 所有指标（6+个字段） |
| **数据拉取** | 仅 `daily_basic` 换手率数据 | `daily` + `daily_basic` + `adj_factor` |
| **计算内容** | pct_turnover_lt_3<br>pct_turnover_gt_5 | 市场宽度<br>恐慌情绪<br>拥挤度<br>换手率 |
| **预计耗时** | **约30秒 - 1分钟** ⚡ | 1-3分钟 |
| **API调用量** | 约3,500次 | 约10,000+次 |
| **适用场景** | 仅修复换手率BUG | 全量重建所有数据 |

---

## ✅ 推荐使用：fix_turnover_only.py

### 工作原理

```python
# 1. 查询换手率为0的记录
SELECT DISTINCT trade_date 
FROM market_breadth 
WHERE pct_turnover_lt_3 = 0 OR pct_turnover_gt_5 = 0

# 2. 仅拉取换手率数据
pro.daily_basic(
    ts_code='...', 
    trade_date=trade_date,
    fields='ts_code,trade_date,turnover_rate'  # 只要换手率
)

# 3. 计算两个换手率指标
pct_lt_3 = (换手率<3%的股票数 / 总股票数) * 100
pct_gt_5 = (换手率>5%的股票数 / 总股票数) * 100

# 4. 更新数据库（只更新换手率字段）
UPDATE market_breadth 
SET pct_turnover_lt_3 = ?, pct_turnover_gt_5 = ?
WHERE trade_date = ? AND index_code = ?
```

### 优势

1. **速度快** ⚡
   - 只拉取换手率数据，不拉取行情和复权因子
   - 只计算2个指标，不重新计算宽度和恐慌度
   - 只更新2个字段，不重写整条记录

2. **精准修复** 🎯
   - 其他字段（宽度、恐慌度）保持不变
   - 不影响已有的正确数据
   - 专注解决换手率BUG

3. **节省配额** 💰
   - API调用次数减少约70%
   - 不浪费Tushare积分

---

## 🚀 使用方法

### 运行脚本
```bash
python fix_turnover_only.py
```

### 输出示例
```
============================================================
仅修复换手率数据（快速模式）
============================================================

1. 检查需要修复的数据...
   需要修复的日期数: 1686
   日期范围: 20190102 ~ 20251212

2. 开始修复换手率数据...
   进度: 1/1686 - 20190102
   进度: 11/1686 - 20190116
   ...
   进度: 1681/1686 - 20251210

3. 验证修复结果...
   总记录数: 6744
   pct_turnover_lt_3 为0: 0 (0.0%)
   pct_turnover_gt_5 为0: 0 (0.0%)
   pct_turnover_lt_3 平均值: 35.20%
   pct_turnover_gt_5 平均值: 28.40%

============================================================
✅ 换手率数据修复完成！共修复 6744 条记录
============================================================
```

---

## ⚙️ Web界面集成

目前Web界面的"全量重建"按钮调用的是 `run_backfill.py`，可以优化为：

### 建议改进（可选）

**修改 `app.py` 中的模式选择器：**

```python
macro_update_mode = st.selectbox(
    "macro_mode_selector",
    ["仅今日", "修复换手率", "全量重建"],  # 新增"修复换手率"选项
    key="macro_update_mode",
    label_visibility="collapsed",
    help="""
    仅今日：更新今天的数据（10-30秒）
    修复换手率：仅修复换手率数据（30-60秒）
    全量重建：重建所有指标数据（1-3分钟）
    """
)
```

**修改按钮逻辑：**

```python
if st.button("📊 数据更新"):
    if macro_update_mode == "仅今日":
        engine.update_today_breadth()
    elif macro_update_mode == "修复换手率":
        import subprocess
        subprocess.run([sys.executable, "fix_turnover_only.py"])
    else:
        run_full_backfill()
    st.rerun()
```

---

## 📋 使用场景对比

| 场景 | 推荐脚本 | 原因 |
|-----|---------|------|
| **换手率BUG修复** | fix_turnover_only.py | 快速、精准 |
| **数据库损坏** | run_backfill.py | 全面重建 |
| **日常更新** | engine.update_today_breadth() | 仅更新今日 |
| **首次初始化** | run_backfill.py | 需要完整数据 |
| **部分指标异常** | 根据具体指标选择 | - |

---

## 💡 当前执行状态

**正在运行：** `fix_turnover_only.py`

**预计耗时：** 30秒 - 1分钟

**当前进度：** 已开始修复换手率数据

**完成后操作：**
1. 刷新 Streamlit 网页
2. 进入宏观Tab页
3. 点击图例显示换手率曲线
4. 验证数据非0

---

## 🎯 总结

✅ **本次修复使用：** `fix_turnover_only.py`（轻量级）

✅ **修复内容：** 仅换手率的2个字段

✅ **预计耗时：** 30-60秒（比全量快2-3倍）

✅ **不影响其他数据：** 市场宽度、恐慌情绪、拥挤度保持不变
