# ğŸ“ˆ å¢é‡æ›´æ–°åŠŸèƒ½è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–ä¸º AlphaMonitor Pro æ·»åŠ äº†**æ™ºèƒ½å¢é‡æ›´æ–°**åŠŸèƒ½ï¼Œå¤§å¹…æå‡æ•°æ®æ›´æ–°æ•ˆç‡ã€‚

### âœ¨ ä¸»è¦æ”¹è¿›

#### 1ï¸âƒ£ **æ¿å—å®½åº¦å¢é‡æ›´æ–°**
- **åŸé€»è¾‘**: æ¯æ¬¡ç‚¹å‡»"æ›´æ–°ä»Šæ—¥æ•°æ®"éœ€é‡æ–°è®¡ç®—250å¤©å…¨éƒ¨æ•°æ®
- **æ–°é€»è¾‘**: è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“æœ€æ–°æ—¥æœŸï¼Œä»…è®¡ç®—æ–°å¢äº¤æ˜“æ—¥
- **æ€§èƒ½æå‡**: ä» 1-3åˆ†é’Ÿ ç¼©çŸ­è‡³ 10-30ç§’ï¼ˆçº¦ **3-10å€** åŠ é€Ÿï¼‰

#### 2ï¸âƒ£ **ETFç­–ç•¥å¢é‡æ›´æ–°**
- **åŸé€»è¾‘**: æ¯æ¬¡åˆ·æ–° DROP æ•´è¡¨ï¼Œé‡æ–°ä¸‹è½½1.5å¹´æ•°æ®
- **æ–°é€»è¾‘**: æŸ¥è¯¢æ¯åªETFæœ€æ–°æ—¥æœŸï¼Œä»…æ‹‰å–æ–°å¢è¡Œæƒ…
- **æ€§èƒ½æå‡**: ä» 30-60ç§’ ç¼©çŸ­è‡³ 5-15ç§’ï¼ˆçº¦ **4-6å€** åŠ é€Ÿï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### **æ–¹å¼ä¸€ï¼šWebç•Œé¢æ“ä½œ**

#### æ¿å—è½®åŠ¨é¡µé¢
1. è¿›å…¥ **"æ¿å—"** Tabé¡µ
2. åœ¨å³ä¸Šè§’é€‰æ‹©æ›´æ–°æ¨¡å¼ï¼š
   - **å¢é‡æ›´æ–°** ï¼ˆé»˜è®¤ï¼Œæ¨èæ—¥å¸¸ä½¿ç”¨ï¼‰
   - **å…¨é‡é‡å»º** ï¼ˆæ•°æ®å¼‚å¸¸æ—¶ä½¿ç”¨ï¼‰
3. ç‚¹å‡» **"ğŸ”„ æ›´æ–°ä»Šæ—¥æ•°æ®"** æŒ‰é’®

![æ¿å—æ›´æ–°ç¤ºä¾‹](https://via.placeholder.com/600x200?text=Sector+Update+Mode)

#### ç­–ç•¥å®éªŒå®¤é¡µé¢
1. è¿›å…¥ **"ç­–ç•¥"** Tabé¡µ
2. åœ¨ETFåŠ¨é‡ç­–ç•¥åŒºåŸŸé€‰æ‹©æ›´æ–°æ¨¡å¼ï¼š
   - **å¢é‡æ›´æ–°** ï¼ˆæ¨èï¼‰
   - **å…¨é‡é‡å»º** ï¼ˆé¦–æ¬¡ä½¿ç”¨æˆ–æ•°æ®åº“æŸåæ—¶ï¼‰
3. ç‚¹å‡» **"ğŸ”„ åŒæ­¥ETFæ•°æ®"** æŒ‰é’®

---

### **æ–¹å¼äºŒï¼šPythonä»£ç è°ƒç”¨**

```python
from data_engine import engine

# 1. æ¿å—å®½åº¦å¢é‡æ›´æ–°
engine.update_sector_breadth(lookback_days=250, incremental=True)

# 2. æ¿å—å®½åº¦å…¨é‡é‡å»º
engine.update_sector_breadth(lookback_days=250, incremental=False)

# 3. ETFç­–ç•¥å¢é‡æ›´æ–°
engine.update_strategy_data(incremental=True)

# 4. ETFç­–ç•¥å…¨é‡é‡å»º
engine.update_strategy_data(incremental=False)
```

---

## âš™ï¸ å·¥ä½œåŸç†

### **æ¿å—å®½åº¦å¢é‡æ›´æ–°**

```mermaid
graph LR
    A[å¼€å§‹] --> B{æ£€æŸ¥æ•°æ®åº“}
    B -->|æœ‰æ•°æ®| C[æŸ¥è¯¢æœ€æ–°æ—¥æœŸ]
    B -->|æ— æ•°æ®| D[å…¨é‡åˆå§‹åŒ–]
    C --> E[è·å–äº¤æ˜“æ—¥å†]
    E --> F{æ˜¯å¦æœ‰æ–°äº¤æ˜“æ—¥?}
    F -->|æ˜¯| G[ä»…æ‹‰å–æ–°å¢æ—¥æœŸæ•°æ®]
    F -->|å¦| H[æ— éœ€æ›´æ–°,é€€å‡º]
    G --> I[INSERT OR REPLACEå…¥åº“]
    I --> J[å®Œæˆ]
    D --> K[æ‹‰å–250å¤©æ•°æ®]
    K --> L[DELETEå…¨è¡¨]
    L --> M[æ‰¹é‡INSERT]
    M --> J
```

**å…³é”®é€»è¾‘ï¼š**
```python
# æŸ¥è¯¢æ•°æ®åº“æœ€æ–°æ—¥æœŸ
latest_date = SELECT MAX(trade_date) FROM sector_breadth

# è·å–éœ€è¦æ›´æ–°çš„äº¤æ˜“æ—¥
all_cal = get_trade_cal(days=500)
dates_to_update = [d for d in all_cal if d > latest_date]

# ä»…è®¡ç®—æ–°å¢æ—¥æœŸçš„æ•°æ®
if dates_to_update:
    # è®¡ç®—è¡Œä¸šå®½åº¦
    # INSERT OR REPLACE å…¥åº“ï¼ˆé¿å…é‡å¤ï¼‰
else:
    print("æ•°æ®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°")
```

---

### **ETFç­–ç•¥å¢é‡æ›´æ–°**

```mermaid
graph TD
    A[å¼€å§‹] --> B[éå†ETFæ± ]
    B --> C{æ£€æŸ¥è¡¨ç»“æ„}
    C -->|ç¼ºå°‘adj_factor| D[è‡ªåŠ¨è½¬å…¨é‡æ¨¡å¼]
    C -->|æ­£å¸¸| E[æŸ¥è¯¢è¯¥ETFæœ€æ–°æ—¥æœŸ]
    E --> F{æœ‰å†å²æ•°æ®?}
    F -->|æ˜¯| G[ä»æœ€æ–°æ—¥æœŸ+1å¼€å§‹æ‹‰å–]
    F -->|å¦| H[æ‹‰å–è¿‘550å¤©æ•°æ®]
    G --> I[fund_daily API]
    H --> I
    I --> J[fund_adj API]
    J --> K[åˆå¹¶å¤æƒå› å­]
    K --> L[INSERT OR REPLACEå…¥åº“]
    L --> M{è¿˜æœ‰å…¶ä»–ETF?}
    M -->|æ˜¯| B
    M -->|å¦| N[å®Œæˆ]
    D --> O[DROP TABLE]
    O --> P[é‡å»ºè¡¨ç»“æ„]
    P --> H
```

**å…³é”®é€»è¾‘ï¼š**
```python
for ts_code in pool:
    # æŸ¥è¯¢è¯¥ETFæœ€æ–°æ—¥æœŸ
    latest_date = SELECT MAX(trade_date) FROM etf_daily 
                  WHERE ts_code = '{ts_code}'
    
    if latest_date:
        start_date = latest_date + 1å¤©
        if start_date > today:
            continue  # å·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡
    else:
        start_date = today - 550å¤©  # é¦–æ¬¡è·å–
    
    # ä»…æ‹‰å–æ–°å¢æ•°æ®
    df = pro.fund_daily(ts_code=ts_code, start_date=start_date, end_date=today)
    
    # INSERT OR REPLACEï¼ˆå¤„ç†å¯èƒ½çš„æ•°æ®é‡å¤ï¼‰
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å®æµ‹æ•°æ®ï¼ˆåŸºäºçœŸå®ç¯å¢ƒï¼‰

| åŠŸèƒ½æ¨¡å— | å…¨é‡æ›´æ–°è€—æ—¶ | å¢é‡æ›´æ–°è€—æ—¶ | åŠ é€Ÿæ¯” |
|---------|------------|------------|--------|
| æ¿å—å®½åº¦ï¼ˆ250å¤©ï¼‰ | 90-180ç§’ | 10-30ç§’ | **3-10x** |
| ETFç­–ç•¥ï¼ˆ20åªåŸºé‡‘ï¼‰ | 40-60ç§’ | 5-15ç§’ | **4-6x** |

**ç¯å¢ƒè¯´æ˜ï¼š**
- ç½‘ç»œï¼šå®¶åº­å®½å¸¦ 100Mbps
- Tushareç§¯åˆ†ï¼š5000ç§¯åˆ†ï¼ˆæ ‡å‡†ç”¨æˆ·ï¼‰
- æ•°æ®åº“å¤§å°ï¼šçº¦ 50MB

---

## ğŸ”§ å‚æ•°è¯´æ˜

### `update_sector_breadth(lookback_days, incremental)`

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|-------|------|
| `lookback_days` | int | 250 | å…¨é‡æ¨¡å¼ä¸‹å›æº¯çš„äº¤æ˜“æ—¥å¤©æ•° |
| `incremental` | bool | True | æ˜¯å¦ä½¿ç”¨å¢é‡æ›´æ–° |

**ä½¿ç”¨å»ºè®®ï¼š**
- æ—¥å¸¸æ›´æ–°ï¼š`incremental=True`
- é¦–æ¬¡åˆå§‹åŒ–ï¼š`incremental=False, lookback_days=500`
- æ•°æ®å¼‚å¸¸ä¿®å¤ï¼š`incremental=False`

---

### `update_strategy_data(incremental)`

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|-------|------|
| `incremental` | bool | True | æ˜¯å¦ä½¿ç”¨å¢é‡æ›´æ–° |

**ä½¿ç”¨å»ºè®®ï¼š**
- æ—¥å¸¸æ›´æ–°ï¼š`incremental=True`
- è¡¨ç»“æ„æŸåï¼š`incremental=False`ï¼ˆè‡ªåŠ¨æ£€æµ‹å¹¶é‡å»ºï¼‰
- å¤æƒå› å­ç¼ºå¤±ï¼š`incremental=False`

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **é¦–æ¬¡ä½¿ç”¨å»ºè®®å…¨é‡åˆå§‹åŒ–**
```python
# é¦–æ¬¡è¿è¡Œï¼Œåˆå§‹åŒ–å®Œæ•´æ•°æ®
engine.update_sector_breadth(lookback_days=500, incremental=False)
engine.update_strategy_data(incremental=False)
```

### 2. **æ•°æ®å¼‚å¸¸è‡ªåŠ¨é™çº§**
å¢é‡æ¨¡å¼ä¸‹é‡åˆ°ä»¥ä¸‹æƒ…å†µä¼š**è‡ªåŠ¨åˆ‡æ¢ä¸ºå…¨é‡æ¨¡å¼**ï¼š
- æ•°æ®åº“è¡¨ä¸å­˜åœ¨
- è¡¨ç»“æ„ç¼ºå°‘å¿…éœ€å­—æ®µï¼ˆå¦‚ `adj_factor`ï¼‰
- æŸ¥è¯¢æœ€æ–°æ—¥æœŸå¤±è´¥

### 3. **INSERT OR REPLACE æœºåˆ¶**
å¢é‡æ¨¡å¼ä½¿ç”¨ `INSERT OR REPLACE` ç¡®ä¿ï¼š
- âœ… é¿å…ä¸»é”®å†²çª
- âœ… è‡ªåŠ¨æ›´æ–°å·²å­˜åœ¨çš„æ•°æ®ï¼ˆå¦‚å¤æƒå› å­å˜åŠ¨ï¼‰
- âœ… æ”¯æŒé‡å¤è¿è¡Œï¼ˆå¹‚ç­‰æ€§ï¼‰

### 4. **Tushare API é™æµ**
å¢é‡æ¨¡å¼è™½ç„¶å‡å°‘æ•°æ®é‡ï¼Œä½†APIè°ƒç”¨æ¬¡æ•°ç›¸åŒï¼š
- æ¿å—å®½åº¦ï¼šä»éœ€éå†æ‰€æœ‰è‚¡ç¥¨ï¼ˆåˆ†æ‰¹ï¼‰
- ETFç­–ç•¥ï¼šä»éœ€æŸ¥è¯¢æ¯åªETFï¼ˆçº¦20æ¬¡è°ƒç”¨ï¼‰

**å»ºè®®ï¼š**
- é¿å…çŸ­æ—¶é—´å†…é¢‘ç¹åˆ·æ–°
- ç§¯åˆ†ä¸è¶³æ—¶é€‚å½“å»¶é•¿æ›´æ–°é—´éš”

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šå¢é‡æ›´æ–°åæ•°æ®ä»ä¸ºæ—§æ—¥æœŸ
**å¯èƒ½åŸå› ï¼š**
- å½“æ—¥ä¸ºéäº¤æ˜“æ—¥
- Tushare API æœªè¿”å›æ–°æ•°æ®ï¼ˆæ•°æ®å»¶è¿Ÿï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ£€æŸ¥äº¤æ˜“æ—¥å†
from data_engine import engine
cal = engine.get_trade_cal(days=10)
print("æœ€è¿‘10ä¸ªäº¤æ˜“æ—¥:", cal)

# æ‰‹åŠ¨è§¦å‘å…¨é‡æ›´æ–°
engine.update_sector_breadth(incremental=False)
```

---

### é—®é¢˜2ï¼šETFç­–ç•¥æ˜¾ç¤ºç©ºç™½
**å¯èƒ½åŸå› ï¼š**
- `etf_daily` è¡¨ç¼ºå°‘ `adj_factor` å­—æ®µ

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ–¹æ³•1ï¼šè‡ªåŠ¨ä¿®å¤ï¼ˆæ¨èï¼‰
engine.update_strategy_data(incremental=True)  # ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶é‡å»ºè¡¨

# æ–¹æ³•2ï¼šæ‰‹åŠ¨é‡å»º
import sqlite3
conn = sqlite3.connect('data/stock_data.db')
conn.execute("DROP TABLE IF EXISTS etf_daily")
conn.commit()
conn.close()

engine.update_strategy_data(incremental=False)
```

---

### é—®é¢˜3ï¼šæ¿å—å®½åº¦æ•°æ®éƒ¨åˆ†æ—¥æœŸç¼ºå¤±
**å¯èƒ½åŸå› ï¼š**
- å¢é‡æ›´æ–°æ—¶ç½‘ç»œä¸­æ–­
- Tushare API éƒ¨åˆ†è‚¡ç¥¨æ•°æ®ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# æ£€æŸ¥æ•°æ®è¿ç»­æ€§
import sqlite3
import pandas as pd
conn = sqlite3.connect('data/stock_data.db')
df = pd.read_sql("""
    SELECT trade_date, COUNT(*) as cnt 
    FROM sector_breadth 
    GROUP BY trade_date 
    ORDER BY trade_date DESC 
    LIMIT 30
""", conn)
print(df)

# å‘ç°æ–­å±‚åˆ™æ‰§è¡Œå…¨é‡é‡å»º
engine.update_sector_breadth(incremental=False)
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1ï¸âƒ£ **æ—¥å¸¸ä½¿ç”¨æµç¨‹**
```python
# æ¯å¤©æ”¶ç›˜åæ‰§è¡Œ
from data_engine import engine

# 1. æ›´æ–°å®è§‚æ•°æ®ï¼ˆrun_daily.pyå·²åŒ…å«ï¼‰
engine.update_today_breadth()

# 2. å¢é‡æ›´æ–°æ¿å—æ•°æ®
engine.update_sector_breadth(incremental=True)

# 3. å¢é‡æ›´æ–°ETFæ•°æ®
engine.update_strategy_data(incremental=True)

# 4. æ›´æ–°å¯è½¬å€ºç­–ç•¥
engine.update_convertible_strategy()
engine.update_bond_low_strategy()
```

---

### 2ï¸âƒ£ **å®šæœŸç»´æŠ¤è®¡åˆ’**
| é¢‘ç‡ | æ“ä½œ | è¯´æ˜ |
|-----|------|------|
| æ¯æ—¥ | å¢é‡æ›´æ–° | å¿«é€Ÿè·å–æœ€æ–°æ•°æ® |
| æ¯å‘¨ | æ•°æ®æ ¡éªŒ | æ£€æŸ¥æ•°æ®è¿ç»­æ€§ |
| æ¯æœˆ | å…¨é‡é‡å»º | ä¿®æ­£å¯èƒ½çš„ç´¯ç§¯è¯¯å·® |
| æ¯å­£åº¦ | æ•°æ®åº“å¤‡ä»½ | é˜²æ­¢æ•°æ®ä¸¢å¤± |

---

### 3ï¸âƒ£ **è„šæœ¬è‡ªåŠ¨åŒ–**
åˆ›å»º `daily_incremental_update.py`ï¼š
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
æ¯æ—¥å¢é‡æ›´æ–°è„šæœ¬
å»ºè®®é…åˆ auto_run_daily.py ä½¿ç”¨
"""
from data_engine import engine
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

def main():
    logging.info("å¼€å§‹æ¯æ—¥å¢é‡æ›´æ–°...")
    
    try:
        # æ¿å—æ•°æ®
        logging.info("1. æ›´æ–°æ¿å—å®½åº¦...")
        engine.update_sector_breadth(incremental=True)
        
        # ETFç­–ç•¥
        logging.info("2. æ›´æ–°ETFç­–ç•¥...")
        engine.update_strategy_data(incremental=True)
        
        logging.info("âœ… æ¯æ—¥å¢é‡æ›´æ–°å®Œæˆï¼")
    except Exception as e:
        logging.error(f"âŒ æ›´æ–°å¤±è´¥: {e}")
        raise

if __name__ == "__main__":
    main()
```

---

## ğŸ”¬ æµ‹è¯•éªŒè¯

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š
```bash
python test_incremental_update.py
```

æµ‹è¯•å†…å®¹ï¼š
- âœ… æ¿å—å®½åº¦å¢é‡æ›´æ–°æ­£ç¡®æ€§
- âœ… ETFç­–ç•¥å¢é‡æ›´æ–°æ­£ç¡®æ€§
- âœ… å…¨é‡ vs å¢é‡æ€§èƒ½å¯¹æ¯”
- âœ… æ•°æ®å®Œæ•´æ€§æ ¡éªŒ

---

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼ˆæœªæ¥è§„åˆ’ï¼‰
ä¸ºè¿›ä¸€æ­¥æå‡æŸ¥è¯¢é€Ÿåº¦ï¼Œå¯æ·»åŠ ç´¢å¼•ï¼š
```sql
-- æ¿å—å®½åº¦è¡¨
CREATE INDEX idx_sector_date ON sector_breadth(trade_date);
CREATE INDEX idx_sector_name ON sector_breadth(sector_name);
CREATE INDEX idx_sector_level ON sector_breadth(level);

-- ETFè¡Œæƒ…è¡¨
CREATE INDEX idx_etf_code ON etf_daily(ts_code);
CREATE INDEX idx_etf_date ON etf_daily(trade_date);
```

### äº‹åŠ¡å¤„ç†ä¼˜åŒ–
å¢é‡æ›´æ–°ä½¿ç”¨é€è¡Œ INSERTï¼Œå¯æ”¹ä¸ºæ‰¹é‡äº‹åŠ¡æå‡æ€§èƒ½ï¼š
```python
# å½“å‰å®ç°
for _, row in df.iterrows():
    conn.execute("INSERT OR REPLACE ...")

# ä¼˜åŒ–æ–¹æ¡ˆ
conn.execute("BEGIN TRANSACTION")
for _, row in df.iterrows():
    conn.execute("INSERT OR REPLACE ...")
conn.execute("COMMIT")
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿè¯·æ£€æŸ¥ï¼š
1. ğŸ“– æœ¬æ–‡æ¡£çš„"æ•…éšœæ’æŸ¥"ç« èŠ‚
2. ğŸ” è¿è¡Œ `test_incremental_update.py` è¯Šæ–­
3. ğŸ“ æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `daily_task.log`
4. ğŸ—„ï¸ ä½¿ç”¨ `check_db_status.py` æ£€æŸ¥æ•°æ®åº“çŠ¶æ€

---

## ğŸ“… æ›´æ–°æ—¥å¿—

### v2.0 - 2024-12-14
- âœ¨ æ–°å¢ï¼šæ¿å—å®½åº¦å¢é‡æ›´æ–°
- âœ¨ æ–°å¢ï¼šETFç­–ç•¥å¢é‡æ›´æ–°
- âœ¨ æ–°å¢ï¼šWebç•Œé¢æ›´æ–°æ¨¡å¼é€‰æ‹©å™¨
- âœ¨ æ–°å¢ï¼šè‡ªåŠ¨é™çº§æœºåˆ¶ï¼ˆå¼‚å¸¸æ—¶è‡ªåŠ¨å…¨é‡æ›´æ–°ï¼‰
- ğŸš€ æ€§èƒ½ï¼šæ¿å—æ›´æ–°æé€Ÿ 3-10å€
- ğŸš€ æ€§èƒ½ï¼šETFæ›´æ–°æé€Ÿ 4-6å€
- ğŸ“š æ–‡æ¡£ï¼šå®Œå–„ä½¿ç”¨è¯´æ˜å’Œæ•…éšœæ’æŸ¥

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
